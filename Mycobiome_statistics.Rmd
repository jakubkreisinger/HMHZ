---
title: "Gut mycobiome analyses"
author: "Jakub Kreisinger"
date: "September 5, 2023"
output: html_document
---

#Pro ucely revize:
-Misto Bray-Curtise - pouzivam clr transformaci
-Dalsi veci jsou zmenene v souboru revize_dodelavky

Zmeny proti v2:
-Prostorove korelace samostatne pro jednotlive transekty
-oprvene mdmd a PCNM - jenom osy signifikantni po multiple testing...



```{r }
library(dada2)
library(phyloseq)
library(ggplot2)
library(vegan)
library(plyr)
library(spaMM)
library(glmmTMB)
library(doSNOW)
library(DHARMa)
library(ggpubr)
library(microbiome)
library(spaMM)
library(ape)
library(MDMR)
library(LDM)
library(Hmsc)
library(car)
library(glmmTMB)
library(magrittr)
library(dplyr)
library(spaMM)

c25 <- c("dodgerblue2","#E31A1C", # red
         "green4",
         "#6A3D9A", # purple
         "#FF7F00", # orange
         "black","gold1",
         "skyblue2","#FB9A99", # lt pink
         "palegreen2",
         "#CAB2D6", # lt purple
         "#FDBF6F", # lt orange
         "gray70", "khaki2",
         "maroon","orchid1","deeppink1","blue1","steelblue4",
         "darkturquoise","green1","yellow4","yellow3",
         "darkorange4","brown")

manage_unassigned<-function(PHYLOSEQ,UNASS_STRING=NA,ADD,AFTER=TRUE){
   TAXall<-data.frame(tax_table(PHYLOSEQ),stringsAsFactors = F)
   if(!is.na(UNASS_STRING)){TAXall[UNASS_STRING]<-NA}
   # TAXall<-as.character(TAXall[i,])
   for(i in 1:dim(TAXall)[1]){  
       TAX<-as.character(TAXall[i,])
       if(AFTER==TRUE) {for(j in 2: length(TAX)){
                            if(is.na(TAX[j])){TAX[j]<-ifelse(regexpr(ADD,TAX[j-1])>0,
                                           TAX[j-1],paste(TAX[j-1],ADD,sep=""))}}}
      if(AFTER==FALSE) {for(j in 2: length(TAX)){
                            if(is.na(TAX[j])){TAX[j]<-ifelse(regexpr(ADD,TAX[j-1])>0,
                                     TAX[j-1],ADD,paste(TAX[j-1],sep=""))}}}
      TAXall[i,]<-TAX
    }
   TAXA<-colnames(TAXall)
   SPECIES<-rownames(TAXall)
   TAXall<-tax_table(TAXall)
   taxa_names(TAXall)<-SPECIES
   colnames(TAXall)<-TAXA
   tax_table(PHYLOSEQ)<-TAXall
  
   #output
   PHYLOSEQ
}


phyloseq_2_GG<-function(which.taxa,which.phyloseq,manage.ussigned=NULL,unassign.string=NULL){  
  RESULT<-data.frame(stringsAsFactors = F)
  subset_phylos<-prune_taxa(taxa_names(which.phyloseq)%in%which.taxa,which.phyloseq)
  SSUMS<-sample_sums(which.phyloseq)
  for(i in 1: length(which.taxa))
    {
      actual.phylos<-prune_taxa(taxa_names(which.phyloseq)%in%which.taxa[i],which.phyloseq)
      Abundance<-as.numeric(otu_table(actual.phylos))  
      OTU<-rep(which.taxa[i],length(Abundance))
      Seq.tot<-rep(SSUMS[i],length(Abundance))
      Seq.tot<-SSUMS
      Taxo.actual<-as.character(tax_table(actual.phylos))
      if(manage.ussigned==T){
        for(j in 2: length(Taxo.actual)){
          if(is.na(Taxo.actual[j])){Taxo.actual[j]<-ifelse(regexpr(unassign.string,Taxo.actual[j-1])>0,
                                           Taxo.actual[j-1],paste(Taxo.actual[j-1],unassign.string,sep=""))}
        }
      }
      
      Taxo.actual.rbind<-do.call("rbind", replicate(length(sample_sums(actual.phylos)), Taxo.actual, simplify = FALSE))
      colnames(Taxo.actual.rbind)<-colnames(tax_table(which.phyloseq))
      Sd<-sample_data(actual.phylos)
      TEMP<-data.frame(Abundance,OTU,Seq.tot,Taxo.actual.rbind,Sd,stringsAsFactors = F)
      RESULT<-rbind(RESULT,TEMP)
    }
    RESULT
}


```



#Decriptive statistics

```{r fig.width=15,fig.height=15}

save(PHYLOSEQ_ITS_HZ_final.800.sub,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PHYLOSEQs/PHYLOSEQ_ITS_HZ_final.800.sub.R")

summary(sample_sums(PHYLOSEQ_ITS_HZ_final.800.sub))
PHYLOSEQ_ITS_HZ_final.800.sub
sum(otu_table(PHYLOSEQ_ITS_HZ_final.800.sub))
```


# Alpha diversity - data preparation

```{r fig.width=15,fig.height=15}

RICH_all<-estimate_richness(PHYLOSEQ_ITS_HZ_final.800.sub,measures=c("Observed","Shannon"))
summary(RICH_all$Observed)
sd(RICH_all$Observed)


PHYLOSEQ_ITS_HZ_final.800.sub

PHYLOSEQ_ITS_HZ_final.800.sub.rare<-rarefy_even_depth(PHYLOSEQ_ITS_HZ_final.800.sub)
RICH<-estimate_richness(PHYLOSEQ_ITS_HZ_final.800.sub.rare,measures = c("Observed","Shannon"))
RICH<-data.frame(RICH,sample_data(PHYLOSEQ_ITS_HZ_final.800.sub.rare))

```

# Alpha diversita (ASV richness) - SPAMM mixed models


```{r }

RICH$Transect_REG<-RICH$Transect=="HZ_REG"
RICH$Transect_CZ<-RICH$Transect!="HZ_REG"


#AIC for A) spatial and B) non-spatial models
RICH$Observed.log<-log10(RICH$Observed)
m_spamm_null_sp <- fitme(log10(Observed) ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "REML",
                           control.glm=list(maxit=200))


m_spamm_null_loc <- fitme(Observed.log ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = RICH, method = "REML",
                           control.glm=list(maxit=200))


AIC(m_spamm_null_sp)
AIC(m_spamm_null_loc)

############################################
#ASV richness (spatial) - model selection ##
############################################
#FUll model
m1 <- fitme(log10(Observed) ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species:Admix
m2 <- fitme(log10(Observed) ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m3 <- fitme(log10(Observed) ~Gravid_my+BW+Species+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m4 <- fitme(log10(Observed) ~Gravid_my+BW+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Gravid_my
m5 <- fitme(log10(Observed) ~BW+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m6 <- fitme(log10(Observed) ~Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m7 <- fitme(log10(Observed) ~1+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))
#LR test
A1<-anova(m1,m2)$ basicLRT
A2<-anova(m2,m3)$ basicLRT
A3<-anova(m4,m3)$ basicLRT
A4<-anova(m4,m5)$ basicLRT
A5<-anova(m6,m5)$ basicLRT
A6<-anova(m6,m7)$ basicLRT

OBS_sp<-data.frame(Predictor=c("Admix x Species","Admix","Species","Gravid_my","BW","Transect"),
                   Response="Observed",
                   rbind(A1,A2,A3,A4,A5,A6))
OBS_sp
FIXED_obs_sp<-summary(m1)$beta_table
################################################
#ASV richness (non-spatial) - model selection ##
################################################
#Full model
m1 <- fitme(log10(Observed) ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species:Admix
m2 <- fitme(log10(Observed) ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m3 <- fitme(log10(Observed) ~Gravid_my+BW+Species+Transect+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m4 <- fitme(log10(Observed) ~Gravid_my+BW+Transect+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Gravid_my
m5 <- fitme(log10(Observed) ~BW+Transect+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m6 <- fitme(log10(Observed) ~Transect+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m7 <- fitme(log10(Observed) ~1+
                           (1|Locality_my),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))
A1<-anova(m1,m2)$ basicLRT
A2<-anova(m2,m3)$ basicLRT
A3<-anova(m4,m3)$ basicLRT
A4<-anova(m4,m5)$ basicLRT
A5<-anova(m6,m5)$ basicLRT
A6<-anova(m6,m7)$ basicLRT

OBS_nonsp<-data.frame(Predictor=c("Admix x Species","Admix","Species","Gravid_my","BW","Transect"),
                   Response="Observed",
                   rbind(A1,A2,A3,A4,A5,A6))
OBS_nonsp
FIXED_obs_nonsp<-summary(m1)$beta_table

```

# Alpha diversity (Shannon) - SPAMM mixed models

```{r fig.width=15,fig.height=15}
#AIC for A) spatial and B) non-spatial models
m_spamm_null_sp <- fitme(Shannon ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "REML",
                           control.glm=list(maxit=200))


m_spamm_null_loc <- fitme(Shannon ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = RICH, method = "REML",
                           control.glm=list(maxit=200))


AIC(m_spamm_null_sp)
AIC(m_spamm_null_loc)

#########################################
#Shannon (spatial) - model selection#####
#########################################
#Full model
m1 <- fitme(Shannon ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species:Admix
m2 <- fitme(Shannon ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Gravid_my
m3 <- fitme(Shannon ~BW+Species+Admix+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m4 <- fitme(Shannon ~BW+Species+Transect+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m5 <- fitme(Shannon ~BW+Species+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m6 <- fitme(Shannon ~BW+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m7 <- fitme(Shannon ~1+
                           (1|Locality_my) +
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))
#LR tests
A1<-anova(m1,m2)$ basicLRT
A2<-anova(m2,m3)$ basicLRT
A3<-anova(m4,m3)$ basicLRT
A4<-anova(m4,m5)$ basicLRT
A5<-anova(m6,m5)$ basicLRT
A6<-anova(m6,m7)$ basicLRT
SH_sp<-data.frame(Predictor=c("Admix x Species","Gravid_my","Admix","Transect","Species","BW"),
                   Response="Shannon",
                   rbind(A1,A2,A3,A4,A5,A6))
SH_sp
FIXED_sh_sp<-summary(m1)$beta_table
#############################################
#Shannon (non-spatial) - model selection#####
#############################################
#Full model
m1 <- fitme(Shannon ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))
#Without Species:Admix
m2 <- fitme(Shannon ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))
#Without Gravid_my
m3 <- fitme(Shannon ~BW+Species+Admix+Transect+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m4 <- fitme(Shannon ~BW+Species+Transect+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m5 <- fitme(Shannon ~BW+Species+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m6 <- fitme(Shannon ~BW+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m7 <- fitme(Shannon ~Species+
                           (1|Locality_my) ,
                           data = RICH, method = "ML",
                           control.glm=list(maxit=200))
#LR tests
A1<-anova(m1,m2)$ basicLRT
A2<-anova(m2,m3)$ basicLRT
A3<-anova(m4,m3)$ basicLRT
A4<-anova(m4,m5)$ basicLRT
A5<-anova(m5,m6)$ basicLRT
A5<-anova(m5,m7)$ basicLRT

SH_nonsp<-data.frame(Predictor=c("Admix x Species","Gravid_my","Admix","Transect","Species","BW"),
                   Response="Shannon",
                   rbind(A1,A2,A3,A4,A5,A6))
SH_nonsp
FIXED_sh_nonsp<-summary(m1)$beta_table
```

# 3.D Alpha diversity -final tables

```{r fig.width=15,fig.height=15}

DF<-data.frame(rbind(cbind(OBS_sp[,c(1,2,4,3,5)],OBS_nonsp[,c(3,5)]),
                     cbind(SH_sp[,c(1,2,4,3,5)],SH_nonsp[,c(3,5)])))

write.table(DF,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/ALPHA.table_myco_interaction.txt",
            sep="\t",row.names = F,quote = F)
DF


DF.fixed<-data.frame(Predictor=rep(rownames(FIXED_obs_sp),2),
                     Response=rep(c("Observed","Shannon"),each=dim(FIXED_obs_sp)[1]),
                     rbind(cbind(FIXED_obs_sp,FIXED_obs_nonsp),
                           cbind(FIXED_sh_sp,FIXED_sh_nonsp)))
DF.fixed
write.table(DF.fixed,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/ALPHA_param_myco_interaction.txt",
            sep="\t",row.names = F,quote = F)



t.test(DF$chi2_LR,DF$chi2_LR.1,paired = T)
DF.fixed.0<-DF.fixed[-grep("Interc",DF.fixed$Predictor),]
t.test(abs(DF.fixed.0$Estimate),abs(DF.fixed.0$Estimate.1),paired = T)
t.test(DF.fixed.0$Cond..SE,DF.fixed.0$Cond..SE.1,paired = T)

```


# PCoA - Bray-Curtis and Jaccard dissimilarities

```{r fig.width=15,fig.height=15}
library(Imap)
library(SoDA)
#######################################
#Bray-Curtis + Jaccard dissimilarities#
#######################################

sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Admix_sq.rt<-sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Admix^0.5
sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Admix_cat<-ifelse(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Admix>0.15,"admixed","non-admixed")


PHYLOSEQ_ITS_HZ_final.800.sub.trans<-transform_sample_counts(PHYLOSEQ_ITS_HZ_final.800.sub, function(x) x/sum(x))
PHYLOSEQ_ITS_HZ_final.800.sub.rare<-rarefy_even_depth(PHYLOSEQ_ITS_HZ_final.800.sub)
PHYLOSEQ_ITS_HZ_final.800.sub.clr <- microbiome::transform(PHYLOSEQ_ITS_HZ_final.800.sub, "clr")

bc<-vegdist(otu_table(PHYLOSEQ_ITS_HZ_final.800.sub.trans)^0.5)
ja<-vegdist(data.frame(otu_table(PHYLOSEQ_ITS_HZ_final.800.sub.rare)),method = "jaccard",binary = T)


###PCoA - Bray-Curtis #####################
bc.ord<-ordinate(PHYLOSEQ_ITS_HZ_final.800.sub.trans,distance=bc,method = "PCoA")
Transect.labs<-c("Transect: Bavarian","Transect: Regensburg")
Species.labs<-c("Subspecies: MMD","Subspecies: MMM")
names(Transect.labs)<-levels(as.factor(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Transect))
names(Species.labs)<-levels(as.factor(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Species))
ORD_PLOT<-plot_ordination(PHYLOSEQ_ITS_HZ_final.800.sub,bc.ord,color = "Admix_sq.rt")+
               facet_grid(Transect~Species,labeller = labeller(Transect = Transect.labs, 
                                                               Species = Species.labs))

plot_ordination(PHYLOSEQ_ITS_HZ_final.800.sub,bc.ord,color = "Admix",axes = c(1,2))+
               facet_grid(Transect~Species,labeller = labeller(Transect = Transect.labs, 
                                                               Species = Species.labs))

ORD_PLOT<-ORD_PLOT+theme_bw()+scale_color_continuous(type = "viridis")+geom_point(size=2,alpha=0.5)
ORD_PLOT$layers[[1]]<-NULL
ORD_PLOT.bc<-ORD_PLOT

DF.bc<-bc.ord$vectors
DF.bc<-data.frame(DF.bc,sample_data(PHYLOSEQ_ITS_HZ_final.800.sub))


###PCoA - Jaccard#############
ja.ord<-ordinate(PHYLOSEQ_ITS_HZ_final.800.sub,method = "PCoA",distance=ja)
Transect.labs<-c("Transect: Bavarian","Transect: Regensburg")
Species.labs<-c("Subspecies: MMD","Subspecies: MMM")
names(Transect.labs)<-levels(as.factor(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Transect))
names(Species.labs)<-levels(as.factor(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub)$Species))
ORD_PLOT<-plot_ordination(PHYLOSEQ_ITS_HZ_final.800.sub,ja.ord,color = "Admix_sq.rt")+
               facet_grid(Transect~Species,labeller = labeller(Transect = Transect.labs, 
                                                               Species = Species.labs))

ORD_PLOT<-ORD_PLOT+theme_bw()+scale_color_continuous(type = "viridis")+geom_point(size=2,alpha=0.5)
ORD_PLOT$layers[[1]]<-NULL
ORD_PLOT.ja<-ORD_PLOT

DF.ja<-(ja.ord)$vectors
DF.ja<-data.frame(DF.ja,sample_data(PHYLOSEQ_ITS_HZ_final.800.sub))

# final figures
# ggsave(ORD_PLOT.bc,
#        filename = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/ORD_PLOT.bc.pdf",
#        width = 8, height = 8,units="cm")
# ggsave(ORD_PLOT.ja,
#        filename = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/ORD_PLOT.ja.pdf",
#        width = 8, height = 8,units="cm")



ORD_PLOT.bc<-ORD_PLOT.bc+ggtitle("A) Bray-Curtis")
ORD_PLOT.ja<-ORD_PLOT.ja+ggtitle("B) Jaccard")

small.fig<-function(x){x+theme(strip.text = element_text(size=8),
                               axis.text.x = element_text(size=6),
                               axis.text.y = element_text(size=6),
                               axis.title.x = element_text(size=8),
                               axis.title.y = element_text(size=8),
                               legend.title = element_blank())}

ORD_PLOT.bc.s<-small.fig(ORD_PLOT.bc)
ORD_PLOT.ja.s<-small.fig(ORD_PLOT.ja)
GRID<-ggarrange(ORD_PLOT.bc.s,ORD_PLOT.ja.s,common.legend = T,legend="bottom")
ggsave(GRID,filename = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/PCOA_myco_AIT.pdf",
       width = 18, height = 12,units = "cm")

GRID

# save gg objects
save(ORD_PLOT.bc.s,
     file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/ORD_PLOT.bc.s_myco_AIT.R")
save(ORD_PLOT.ja.s,
     file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/ORD_PLOT.ja.s_myco_AIT.R")


```


# Major gradients - Jaccard (spatial)

```{r fig.width=15,fig.height=15}
DF.ja$Transect_REG<-DF.ja$Transect=="HZ_REG"
DF.ja$Transect_CZ<-DF.ja$Transect!="HZ_REG"

##############################
#JACCARD AXIS 1###############
##############################

# AIC spatial vs non-*spatial
m_spamm_null_sp <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),,
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))


m_spamm_null_loc <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

# AIC.ja.1.sp<-print(get_any_IC(m_spamm_null_sp, nsim=100L, seed=123,nb_cores=4))
# AIC.ja.1.loc<-print(get_any_IC(m_spamm_null_loc, nsim=100L, seed=123,nb_cores=4))


##############################################
#JACCARD AXIS 1 (spatial) - model selection###
##############################################

#Full model
m1 <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Gravid_my
m2 <- fitme(Axis.1 ~BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without BW
m3 <- fitme(Axis.1 ~Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Species:Admix
m4 <- fitme(Axis.1 ~Species+Admix+Transect+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m5 <- fitme(Axis.1 ~Admix+Transect+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Transect
m6 <- fitme(Axis.1 ~Admix+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Admix
m7 <- fitme(Axis.1 ~1+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m7,m6)$basicLRT

DF.JA.AX1<-data.frame(Predictor=c("Gravid_my","BW","Admix x Species","Species","Transect","Admix"),
                      rbind(A1,A2,A3,A4,A5,A6))

FULL.JA.AX1<-summary(m1)$beta_table

##############################
#JACCARD AXIS 2###############
##############################

# AIC spatial vs non-*spatial
m_spamm_null_sp <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "REML",
                           control.glm=list(maxit=200))

m_spamm_null_loc <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "REML",
                           control.glm=list(maxit=200))


# AIC.ja.2.sp<-print(get_any_IC(m_spamm_null_sp, nsim=100L, seed=123,nb_cores=4))
# AIC.ja.2.loc<-print(get_any_IC(m_spamm_null_loc, nsim=100L, seed=123,nb_cores=4))

###########################################
#JACCARD AXIS 2 (spatial) - model selection#
########################################### 
#Full model
m1 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without interactions
m2 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Admix
m3 <- fitme(Axis.2 ~Gravid_my+BW+Species+Transect+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Species
m4 <- fitme(Axis.2 ~Gravid_my+BW+Transect+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m5 <- fitme(Axis.2 ~Gravid_my+Transect+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Gravid_my
m6 <- fitme(Axis.2 ~Transect+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Transect
m7 <- fitme(Axis.2 ~1+
                           (1|Locality_my)   +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#LR Tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m7,m6)$basicLRT

DF.JA.AX2<-data.frame(Predictor=c("Admix x Species","Admix","Species","BW","Gravid_my","Transect"),
                      rbind(A1,A2,A3,A4,A5,A6))

FULL.JA.AX2<-summary(m1)$beta_table

```

# Major gradients - Jaccard (non - spatial)
```{r fig.width=15,fig.height=15}
#################################################
#JACCARD AXIS 1 (non- spatial) - model selection#
#################################################

# Full models
m1 <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) ,
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without BW
m2 <- fitme(Axis.1 ~Gravid_my+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) ,
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Gravid_my
m3 <- fitme(Axis.1 ~Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my) ,
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Species:Admix
m4 <- fitme(Axis.1 ~Species+Admix+Transect+
                           (1|Locality_my) ,
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m5 <- fitme(Axis.1 ~Admix+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Transect
m6 <- fitme(Axis.1 ~Admix+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m7 <- fitme(Axis.1 ~Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m5,m7)$basicLRT

DF.JA.AX1_nonsp<-data.frame(Predictor=c("BW","Gravid_my","Admix x Species","Species","Transect","Admix"),
                      rbind(A1,A2,A3,A4,A5,A6))

FULL.JA.AX1_nonsp<-summary(m1)$beta_table
#################################################
#JACCARD AXIS 2 (non- spatial) - model selection#
#################################################

#Full model
m1 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Species:Admix           
m2 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Gravid_my
m3 <- fitme(Axis.2 ~BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without BW
m4 <- fitme(Axis.2 ~Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m5 <- fitme(Axis.2 ~Species+Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))

#Without Species
m6 <- fitme(Axis.2 ~Transect+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#Without Transect
m7 <- fitme(Axis.2 ~1+
                           (1|Locality_my),
                           data = DF.ja, method = "ML",
                           control.glm=list(maxit=200))
#LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A7<-anova(m7,m6)$basicLRT

DF.JA.AX2_nonsp<-data.frame(Predictor=c("Admix x Species","Gravid_my","BW","Admix","Species","Transect"),
                      rbind(A1,A2,A3,A4,A5,A6))

FULL.JA.AX2_nonsp<-summary(m1)$beta_table

```


# Major gradients - Bray-Curtis (spatial)

```{r fig.width=15,fig.height=15}

DF.bc<-bc.ord$vectors

DF.bc$Transect_REG<-DF.bc$Transect=="HZ_REG"
DF.bc$Transect_CZ<-DF.bc$Transect!="HZ_REG"


##############################
#BRAY CURTIS AXIS 1###########
##############################

# AIC spatial vs non-*spatial
m_spamm_null_sp <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

m_spamm_null_loc <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))


# AIC.bc.1.sp<-print(get_any_IC(m_spamm_null_sp, nsim=100L, seed=123,nb_cores=4))
# AIC.bc.1.loc<-print(get_any_IC(m_spamm_null_loc, nsim=100L, seed=123,nb_cores=4))


##############################################
#BRAY CURTIS 1 (spatial) - model selection###
##############################################

# Full model
m1 <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           Admix:Species+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Witout Gravid_my
m2 <- fitme(Axis.1 ~BW+Species+Admix+Transect+
                           Admix:Species+
                           (1|Locality_my) +   
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Witout BW
m3 <- fitme(Axis.1 ~Species+Admix+Transect+
                           Admix:Species+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=400))
#Witout Admix:Species
m4 <- fitme(Axis.1 ~Species+Admix+Transect+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Witout Species
m5 <- fitme(Axis.1 ~Admix+Transect+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Witout Admix
m6 <- fitme(Axis.1 ~Transect+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Witout Transect
m7 <- fitme(Axis.1 ~1+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m7,m6)$basicLRT

DF.BC.AX1<-data.frame(Predictor=c("Gravid_my","BW","Admix x Species","Species","Admix","Transect"),
                      rbind(A1,A2,A3,A4,A5,A6))

FULL.BC.AX1<-summary(m1)$beta_table

##############################
#BRAY CURTIS AXIS 1###########
##############################


# AIC spatial vs non-*spatial
m_spamm_null_sp <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

m_spamm_null_loc <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

# AIC.bc.2.sp<-print(get_any_IC(m_spamm_null_sp, nsim=100L, seed=123,nb_cores=4))
# AIC.bc.2.loc<-print(get_any_IC(m_spamm_null_loc, nsim=100L, seed=123,nb_cores=4))

##############################################
#BRAY CURTIS 2 (spatial) - model selection###
##############################################

# Full model
m1 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Species:Admix
m2 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Gravid_my
m3 <- fitme(Axis.2 ~BW+Species+Admix+Transect+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Admix
m4 <- fitme(Axis.2 ~BW+Species+Transect+
                           (1|Locality_my) +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m5 <- fitme(Axis.2 ~BW+Species+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m6 <- fitme(Axis.2 ~Species+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Species
m7 <- fitme(Axis.2 ~BW+
                           (1|Locality_my)  +  
                           Matern(Transect_REG | X_Longit_mean+ Y_Latit_mean)+
                           Matern(Transect_CZ | X_Longit_mean+ Y_Latit_mean),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
# LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m7,m5)$basicLRT

DF.BC.AX2<-data.frame(Predictor=c("Admix x Species","Gravid_my","Admix","Transect","BW","Species"),
                      rbind(A1,A2,A3,A4,A5,A6))

DF.BC.AX2
FULL.BC.AX2<-summary(m1)$beta_table
```

# Major gradients - Bray-Curtis (non-spatial)

```{r fig.width=15,fig.height=15}

#################################################
#BRAY CURTIS 1 (non-spatial) - model selection###
#################################################
#FUll model
m1 <- fitme(Axis.1 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Gravid_my
m2 <- fitme(Axis.1 ~BW+Species+Admix+Transect+
                           Admix:Species+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without BW
m3 <- fitme(Axis.1 ~Species+Admix+Transect+
                           Admix:Species+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Admix:Species
m4 <- fitme(Axis.1 ~Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without Admix
m5 <- fitme(Axis.1 ~Species+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Species
m6 <- fitme(Axis.1 ~Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m7 <- fitme(Axis.1 ~1+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m6,m7)$basicLRT

DF.BC.AX1_nonsp<-data.frame(Predictor=c("Gravid_my","BW","Admix x Species","Admix","Species","Transect"),
                      rbind(A1,A2,A3,A4,A5,A6))
FULL.BC.AX1_nonsp<-summary(m1)$beta_table

#################################################
#BRAY CURTIS 2 (non-spatial) - model selection###
#################################################

#full model
m1 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           Species:Admix+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without interakce
m2 <- fitme(Axis.2 ~Gravid_my+BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without Gravid_my
m3 <- fitme(Axis.2 ~BW+Species+Admix+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Admix
m4 <- fitme(Axis.2 ~BW+Species+Transect+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without Transect
m5 <- fitme(Axis.2 ~BW+Species+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))

#Without BW
m6 <- fitme(Axis.2 ~Species+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#Without Species
m7 <- fitme(Axis.2 ~1+
                           (1|Locality_my),
                           data = DF.bc, method = "ML",
                           control.glm=list(maxit=200))
#LR tests
A1<-anova(m1,m2)$basicLRT
A2<-anova(m2,m3)$basicLRT
A3<-anova(m3,m4)$basicLRT
A4<-anova(m4,m5)$basicLRT
A5<-anova(m5,m6)$basicLRT
A6<-anova(m6,m7)$basicLRT

DF.BC.AX2_nonsp<-data.frame(Predictor=c("Admix x Species","Gravid_my","Admix","Transect","BW","Species"),
                      rbind(A1,A2,A3,A4,A5,A6))

FULL.BC.AX2_nonsp<-summary(m1)$beta_table


```


#finalni tabulky

```{r fig.width=15,fig.height=15}
####AIC TABLE################
# JA.BC_aic.loc<-c(AIC.bc.1.loc[3],AIC.bc.2.loc[3],AIC.ja.1.loc[3],AIC.ja.2.loc[3])
# JA.BC_aic.sp<-c(AIC.bc.1.sp[3],AIC.bc.2.sp[3],AIC.ja.1.sp[3],AIC.ja.2.sp[3])
# 
# DF_aic<-data.frame(Dissimilarity=c("Bray-Curtis","","Jaccard",""),
#                    Axis=c("Axis 1","Axis 2","Axis 1","Axis 2"),
#                    AIC_spatial=JA.BC_aic.sp,
#                    AIC_nonspatial=JA.BC_aic.loc)
# DF_aic.boot<-DF_aic
# DF_aic.boot
# 
# JA.BC_aic.loc<-c(AIC.bc.1.loc[2],AIC.bc.2.loc[2],AIC.ja.1.loc[2],AIC.ja.2.loc[2])
# JA.BC_aic.sp<-c(AIC.bc.1.sp[2],AIC.bc.2.sp[2],AIC.ja.1.sp[2],AIC.ja.2.sp[2])
# 
# DF_aic<-data.frame(Dissimilarity=c("Bray-Curtis","","Jaccard",""),
#                    Axis=c("Axis 1","Axis 2","Axis 1","Axis 2"),
#                    AIC_spatial=JA.BC_aic.sp,
#                    AIC_nonspatial=JA.BC_aic.loc)
# DF_aic
# 
# write.table(DF_aic,
#             file="/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/AIC.PCOA.myco_AIT.txt",
#             sep="\t",row.names = F)

###########MODEL SELECTION####################
DF.BC.AX2_nonsp <- DF.BC.AX2_nonsp[order(DF.BC.AX2_nonsp$Predictor),] 
DF.BC.AX1_nonsp <- DF.BC.AX1_nonsp[order(DF.BC.AX1_nonsp$Predictor),] 
DF.JA.AX2_nonsp <- DF.JA.AX2_nonsp[order(DF.JA.AX2_nonsp$Predictor),] 
DF.JA.AX1_nonsp <- DF.JA.AX1_nonsp[order(DF.JA.AX1_nonsp$Predictor),] 

DF.BC.AX2 <- DF.BC.AX2[order(DF.BC.AX2$Predictor),] 
DF.BC.AX1 <- DF.BC.AX1[order(DF.BC.AX1$Predictor),] 
DF.JA.AX2 <- DF.JA.AX2[order(DF.JA.AX2$Predictor),] 
DF.JA.AX1 <- DF.JA.AX1[order(DF.JA.AX1$Predictor),] 

DD1<-data.frame(DF.BC.AX1[,c(1,3,2,4)],DF.BC.AX1_nonsp[,c(2,4)])
DD2<-data.frame(DF.BC.AX2[,c(1,3,2,4)],DF.BC.AX2_nonsp[,c(2,4)])
DD3<-data.frame(DF.JA.AX1[,c(1,3,2,4)],DF.JA.AX1_nonsp[,c(2,4)])
DD4<-data.frame(DF.JA.AX2[,c(1,3,2,4)],DF.JA.AX2_nonsp[,c(2,4)])

DF<-data.frame(Dissimilarity=rep(c("Bray-Curtis","Jaccard"),each=dim(DD1)[1]*2),
           Axis=rep(c("axis1","axis2","axis1","axis2"),each=dim(DD1)[1]),
           rbind(DD1,DD2,DD3,DD4))

DF

write.table(DF,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/PCO_lmm_myco_interakce_AIT.txt",
            sep = "\t",quote = F,row.names = F)

#Comparing LR statistics for spatial vs. non-spatial models
t.test((DF$chi2_LR),(DF$chi2_LR.1),paired = T)

#################PARAMETER ESTIMATES#############

DF.EST<-data.frame(Predictor=rep(rownames(FULL.BC.AX1),4),
                   Dissimilarity=rep(c("Bray-Curtis","Jaccard"),each=dim(FULL.BC.AX1)[1]*2),
                   Axis=rep(c("axis1","axis2","axis1","axis2"),each=dim(FULL.BC.AX1)[1]),
                   rbind(cbind(FULL.BC.AX1,FULL.BC.AX1_nonsp),
                         cbind(FULL.BC.AX2,FULL.BC.AX2_nonsp),
                         cbind(FULL.JA.AX1,FULL.JA.AX1_nonsp),
                         cbind(FULL.JA.AX2,FULL.JA.AX2_nonsp)))

write.table(DF.EST,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/PCO_lmm_parameters_myco-_interakce_AIT.txt",
            sep = "\t",quote = F,row.names = F)

DF.EST.0<-DF.EST[-grep("Interc",rownames(DF.EST)),]

#Comparing Estimates and S.E. for spatial vs. non-spatial models
t.test(abs(DF.EST.0$Estimate),abs(DF.EST.0$Estimate.1),paired=T)
t.test(DF.EST.0$Cond..SE,DF.EST.0$Cond..SE.1,paired=T)
mean(DF.EST.0$Cond..SE-DF.EST.0$Cond..SE.1)

```


# db-RDA on PCNM axes - (variation in microbiota composition explained by spatial correlation) 

```{r fig.width=15,fig.height=15,warning=F,message=F}
library(ape)
PHYLOSEQ_ITS_HZ_final.800.sub.rare<-rarefy_even_depth(PHYLOSEQ_ITS_HZ_final.800.sub)
bc<-dist(otu_table(PHYLOSEQ_ITS_HZ_final.800.sub))
ja<-vegdist(data.frame(otu_table(PHYLOSEQ_ITS_HZ_final.800.sub.rare)),binary = T,method = "jaccard")
bc<-as.matrix(bc)
ja<-as.matrix(ja)
NAMES<-paste(sample_names(PHYLOSEQ_ITS_HZ_final.800.sub.rare),
             sample_data(PHYLOSEQ_ITS_HZ_final.800.sub.rare)$Locality_my,
             sample_data(PHYLOSEQ_ITS_HZ_final.800.sub.rare)$Transect,sep="~")

SD<-sample_data(PHYLOSEQ_ITS_HZ_final.800.sub.rare)

# colnames(bc)<-rownames(bc)<-NAMES
# colnames(ja)<-rownames(ja)<-NAMES

ja.pc<-pcoa(ja)$vectors
# bc.pc<-pcoa(bc)$vectors

ja.pc.centr<-apply(ja.pc,2,function(x) tapply(x,SD$Locality_my,mean))
bc.pc.centr<-apply(bc,2,function(x) tapply(x,SD$Locality_my,mean))

X_centr<-tapply(SD$X_Longit_mean,SD$Locality_my,mean)
Y_centr<-tapply(SD$Y_Latit_mean,SD$Locality_my,mean)
GEO<-data.frame(X_centr,Y_centr)

PCNM.vegan<-pcnm(dist(GEO))

#rda for ja
rda.vasc.sp.1<-rda(ja.pc.centr~.,data=data.frame(PCNM.vegan$vectors))
rda.vasc.sp.0<-rda(ja.pc.centr~1,data=data.frame(PCNM.vegan$vectors))
sel.osR2.sp <- ordistep (rda.vasc.sp.0, scope = formula (rda.vasc.sp.1), direction = 'forward')
RsquareAdj(sel.osR2.sp)
anova(sel.osR2.sp)
sel.osR2.sp.ja<-sel.osR2.sp

# rda for bc
rda.vasc.sp.1<-rda(bc.pc.centr~.,data=data.frame(PCNM.vegan$vectors))
rda.vasc.sp.0<-rda(bc.pc.centr~1,data=data.frame(PCNM.vegan$vectors))
sel.osR2.sp <- ordistep (rda.vasc.sp.0, scope = formula (rda.vasc.sp.1), direction = 'forward')
RsquareAdj(sel.osR2.sp)
anova(sel.osR2.sp)
sel.osR2.sp.bc<-sel.osR2.sp


RsquareAdj(sel.osR2.sp.bc)
RsquareAdj(sel.osR2.sp.ja)

anova.cca(sel.osR2.sp.bc,by="margin")
anova.cca(sel.osR2.sp.ja,by="margin")
```

# Whole community approach (MDMR mixed models)
```{r fig.width=15,fig.height=15}
library(MDMR)
library(LDM)

#ANOVA for db-RDA (full model)
ANOVA.sp.bc.g<-anova(sel.osR2.sp.bc)
ANOVA.sp.ja.g<-anova(sel.osR2.sp.ja)
ANOVA.sp.bc.g
ANOVA.sp.ja.g

RsquareAdj(sel.osR2.sp.bc)
RsquareAdj(sel.osR2.sp.ja)

#ANOVA for db-RDA (marginal effects)
ANOVA.sp.bc<-anova(sel.osR2.sp.bc,by="margin")
ANOVA.sp.ja<-anova(sel.osR2.sp.ja,by="margin")


ANOVA.sp.bc$p.adjusted<-p.adjust(ANOVA.sp.bc[,4],method = "holm")
NAMES.bc<-rownames(ANOVA.sp.bc)[ANOVA.sp.bc$p.adjusted<0.05]
NAMES.bc<-NAMES.bc[!is.na(NAMES.bc)]

FORMULA.bc<-as.formula(paste("~", paste(NAMES.bc,collapse = " + ")))

#Refitting dbRDA model (just significant PCNM axes) + R squared
ANOVA.sp.ja$p.adjusted<-p.adjust(ANOVA.sp.ja[,4],method = "holm")
NAMES.ja<-rownames(ANOVA.sp.ja)[ANOVA.sp.ja$p.adjusted<0.05]
NAMES.ja<-NAMES.bc[!is.na(NAMES.ja)]

FORMULA.ja<-as.formula(paste("~", paste(NAMES.ja,collapse = " + ")))

# Data frame for MDMR mixed models
PCNNM.vectors<-data.frame(PCNM.vegan$vectors)
PCNNM.vectors$Locality_my<-rownames(PCNNM.vectors)
SD<-data.frame(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub.rare))
SD<-join(SD,PCNNM.vectors)
SD$DUMMY<-"a"

OTU_TABLE<-data.frame(otu_table(PHYLOSEQ_ITS_HZ_final.800.sub.rare))

X.mat<-SD[,names(SD)%in%c("Gravid_my","BW","Species","Admix","Transect")]

#MDMR Bray-Curtis (non-spatial)
mdmr.bc.nonsp <- MDMR::mixed.mdmr(~Gravid_my+BW+Species+Admix+Transect+
                                    Species:Admix+
                               (1|Locality_my),
                               data =SD,D = bc,
                               ncores=4)
#MDMR Bray-Curtis (spatial)
mdmr.bc.sp <- MDMR::mixed.mdmr(~PCNM1+PCNM2+PCNM3+PCNM4+PCNM5+
                                Gravid_my+BW+Species+Admix+Transect+
                                 Species:Admix+
                               (1|Locality_my),
                               data =SD,D = bc,
                               ncores=4)
#MDMR Jaccard (non-spatial)
mdmr.ja.nonsp <- MDMR::mixed.mdmr(~Gravid_my+BW+Species+Admix+Transect+
                                    Species:Admix+
                               (1|Locality_my),
                               data =SD,D = ja,
                               ncores=4)
#MDMR Jaccard (nspatial)
mdmr.ja.sp <- MDMR::mixed.mdmr(~PCNM1+PCNM2+PCNM3+PCNM4+PCNM5+
                                Gravid_my+BW+Species+Admix+Transect+
                                 Species:Admix+
                               (1|Locality_my),
                               data =SD,D = ja,
                               ncores=4)
# Table for MDMR results
mdmr.bc.nonsp.T<-summary(mdmr.bc.nonsp)
mdmr.bc.sp.T<-summary(mdmr.bc.sp)
mdmr.ja.nonsp.T<-summary(mdmr.ja.nonsp)
mdmr.ja.sp.T<-summary(mdmr.ja.sp)

mdmr.bc.sp.T<-mdmr.bc.sp.T[-grep("PCNM",rownames(mdmr.bc.sp.T)),]
mdmr.ja.sp.T<-mdmr.ja.sp.T[-grep("PCNM",rownames(mdmr.ja.sp.T)),]

DF<-data.frame(Dissimilarity=rep(c("Bray-Curtis","Jaccard"),each=dim(mdmr.bc.sp.T)[1]),
           Predictor=rep(rownames(mdmr.bc.sp.T),2),
           rbind(cbind(mdmr.bc.sp.T[,c(2,1,3)],mdmr.bc.nonsp.T[,c(1,3)]),
           cbind(mdmr.ja.sp.T[,c(2,1,3)],mdmr.ja.nonsp.T[,c(1,3)])))

DF<-DF[DF$Predictor!="Omnibus",]

write.table(DF, file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/MDMR_table_myco_interakce_AIT.txt",
            sep="\t",quote = F,row.names = F)
DF

DF2<-DF[-grep("Interc",DF$Predictor),]
DF2
# Comparing MDMR test statistics for spatial vs. non-spatial models
t.test(DF2$Statistic,DF2$Statistic.1,paired = T)
mean(DF2$Statistic)
mean(DF2$Statistic.1)
DF
```

# Barplots - taxonomy (Genus level)

```{r fig.width=15}

MERGED_class<-tax_glom(PHYLOSEQ_ITS_HZ_final.800.sub.trans, taxrank="Genus",NArm=FALSE)
MERGED_class<-manage_unassigned(MERGED_class,UNASS_STRING=NA,ADD="",AFTER=TRUE)

TS<-taxa_sums(MERGED_class)/sum(otu_table(MERGED_class))
names(TS)<-as.character(tax_table(MERGED_class)[,"Genus"])
rev(sort(TS))[1:20]

OT<-data.frame(otu_table(MERGED_class))
APPLY<-t(apply(OT,2,function(x) tapply(x,sample_data(MERGED_class)$Transect,mean)))
rownames(APPLY)<-as.character(tax_table(MERGED_class)[,"Genus"])
APPLY

phylum.prop = tapply(taxa_sums(MERGED_class), tax_table(MERGED_class)[, "Genus"], sum, na.rm = TRUE)/dim(otu_table(MERGED_class))[1]
sort(phylum.prop, TRUE)[1:15]

top8phyla = names(sort(phylum.prop, TRUE))[1:20]

TAXO<-as.character(tax_table(MERGED_class)[,6])
TAXO[TAXO == "?" ] <- "unassigned"
TAXO[!TAXO %in% c(top8phyla,"unassigned")] <- "others"

tax_table(MERGED_class)[,6]<-TAXO

mdf = psmelt(MERGED_class)

top8phyla.c<-top8phyla
top8phyla.c[is.na(top8phyla.c)]<-"unassigned"

top8phyla.c<-gsub("g__","",top8phyla.c)
mdf$Genus<-gsub("g__","",mdf$Genus)

mdf$Genus<-as.factor(mdf$Genus)
mdf$Genus<-factor(mdf$Genus,levels=c(top8phyla.c,"others"))

# mdf$category<-factor(mdf$category,levels=c("K","1","2"))
# levels(mdf$category)<-c("C","1","2")
library(ggnomics)
library(ggh4x)

mdf$Admix.category<-cut(mdf$Admix,breaks=c(-Inf,0.1, Inf), labels=c("<0.1",">0.1"))

p = ggplot(mdf, aes_string(x = "Sample", y = "Abundance", fill = "Genus",order="Genus"))+theme_bw()
p = p + geom_bar(stat = "identity", position = "stack")
p = p + theme(axis.text.x = element_text(angle = -90, hjust = 0,size=5),axis.text.y = element_text(hjust = 0,size=5),axis.title.x = element_text(size=0))
p <- p + facet_nested(~Transect+sample_Species+Admix.category , scales = "free",space = "free",nest_line = F)+theme(strip.text = element_text(size = 8, angle = 0)) +
  scale_fill_manual(values = c(c25[1:20],"gray"))
p_class_samples<-p


p_class_samples<-p_class_samples+theme(legend.title = element_blank(),
                      legend.position = "bottom",
                      legend.text = element_text(size=8),
                      axis.text.x = element_blank(),
                      legend.key.size = unit(0.5, 'cm'))
p_class_samples
ggsave(p_class_samples,filename = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/genus_tax_myco.pdf",width = 18,height = 10,units = "cm")

p_class_samples.myco<-p_class_samples
save(p_class_samples.myco,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/PLOTS_TABLES/p_class_samples.myco.R")
```

# HMSC models

## Model with spatial autocorrelation 

```{r eval=FALSE, fig.width=15, include=FALSE}
#Selecting AVSs (prevalence > 0.1)
PHYLOSEQ_ITS_HZ_final.800.sub.sub<-PHYLOSEQ_ITS_HZ_final.800.sub

PHYLOSEQ_ITS_HZ_final.800.sub_01<-transform_sample_counts(PHYLOSEQ_ITS_HZ_final.800.sub.sub,function(x) ifelse(x>0,1,0))
PREVAL<-taxa_sums(PHYLOSEQ_ITS_HZ_final.800.sub_01)/nsamples(PHYLOSEQ_ITS_HZ_final.800.sub_01)
#PREVAL
sum(PREVAL>0.1)

PREVAL.otus<-names(PREVAL)[PREVAL>0.1]
PHYLOSEQ_ITS_HZ_final.800.sub_filtered<-prune_taxa(taxa_names(PHYLOSEQ_ITS_HZ_final.800.sub.sub)%in%PREVAL.otus,PHYLOSEQ_ITS_HZ_final.800.sub.sub)

OTU_T<-otu_table(PHYLOSEQ_ITS_HZ_final.800.sub_filtered)

#otu table pro HMSC (rarefied)

PHYLOSEQ_ITS_HZ_final.800.sub.sub.rare<-rarefy_even_depth(PHYLOSEQ_ITS_HZ_final.800.sub.sub)
PHYLOSEQ_ITS_HZ_final.800.sub.sub.rare<-prune_taxa(taxa_names(PHYLOSEQ_ITS_HZ_final.800.sub.sub.rare)%in%taxa_names(OTU_T),PHYLOSEQ_ITS_HZ_final.800.sub.sub.rare)
OTU_T.r<-otu_table(PHYLOSEQ_ITS_HZ_final.800.sub.sub.rare)

#preparing data.frame with explanatory variables
VARIABLES<-c("Gravid_my","BW","Species","Admix")
SD<-data.frame(sample_data(PHYLOSEQ_ITS_HZ_final.800.sub.sub))
SD$SSUMS<-sample_sums(PHYLOSEQ_ITS_HZ_final.800.sub.sub)

MEAN_latid<-tapply(SD$Y_Latit_mean,SD$Transect,mean)
MEAN_longit<-tapply(SD$X_Longit_mean,SD$Transect,mean)

SD$Y_Latit_mean_centered<-ifelse(SD$Transect=="HZ_REG",SD$Y_Latit_mean-MEAN_latid[2],SD$Y_Latit_mean-MEAN_latid[1])
SD$X_Longit_mean_centered<-ifelse(SD$Transect=="HZ_REG",SD$X_Longit_mean-MEAN_longit[2],SD$X_Longit_mean-MEAN_longit[1])

SD$pos <- numFactor(SD$X_Longit_mean_centered, SD$Y_Latit_mean_centered)

SD$BW.s<-scale(SD$BW)
SD$Admix.s<-scale(SD$Admix)



RELEVANT_VARS<-c("Gravid_my","BW.s","Species","Admix.s","Locality_my","SSUMS",
                 "X_Longit_mean_centered", "Y_Latit_mean_centered","Transect") 
SAMPLE.D<-SD
SAMPLE.D<-SAMPLE.D[,names(SAMPLE.D)%in%RELEVANT_VARS]


summary(SAMPLE.D)

SAMPLE.D$Transect<-as.factor(SAMPLE.D$Transect)
SAMPLE.D$Gravid_my<-as.factor(SAMPLE.D$Gravid_my)
SAMPLE.D$Locality_my<-as.factor(SAMPLE.D$Locality_my)
SAMPLE.D$Species<-as.factor(SAMPLE.D$Species)
SAMPLE.D$BW.s<-as.numeric(SAMPLE.D$BW.s)
SAMPLE.D$Admix.s<-as.numeric(SAMPLE.D$Admix.s)

#spatial coordiantes
xycoords<-as.matrix(SAMPLE.D)[,names(SAMPLE.D)%in%c("X_Longit_mean_centered", "Y_Latit_mean_centered")]
xycoords<-apply(xycoords,2,function(x) as.numeric(x))
xycoords<-xycoords[!duplicated(SAMPLE.D$Locality_my),]
rownames(xycoords)<-SAMPLE.D$Locality_my[duplicated(SAMPLE.D$Locality_my)==F]

#study design
studyDesign = data.frame(sample = as.factor(SAMPLE.D$Locality_my))
studyDesign$group<-as.factor(SAMPLE.D$Locality_my)
studyDesign$individual<-as.factor(as.factor(1:dim(SAMPLE.D)[1]))
rownames(studyDesign)<-studyDesign$individual

#random effects
rL.group = HmscRandomLevel(units = levels(studyDesign$group))
rL.indiv = HmscRandomLevel(units = levels(studyDesign$individual))
rL.spatial = HmscRandomLevel(sData = xycoords)
rL.spatial = setPriors(rL.spatial,nfMin=1,nfMax=1)

class(OTU_T.r)<-"matrix"

rownames(OTU_T.r)<-rownames(studyDesign)

##########################################################
#Priprava na run (jen pro nenulove vzorky)################
##########################################################

FILTER<-rowSums(OTU_T.r)>10
FILTER.nonull<-FILTER

#spatial coordiantes
SAMPLE.D_nonull<-SAMPLE.D[FILTER,]
xycoords_nonull<-as.matrix(SAMPLE.D_nonull)[,names(SAMPLE.D_nonull)%in%c("X_Longit_mean_centered",
                                                           "Y_Latit_mean_centered")]
xycoords_nonull<-apply(xycoords_nonull,2,function(x) as.numeric(x))
xycoords_nonull<-xycoords_nonull[!duplicated(SAMPLE.D_nonull$Locality_my),]
rownames(xycoords_nonull)<-SAMPLE.D_nonull$Locality_my[duplicated(SAMPLE.D_nonull$Locality_my)==F]

#study design
studyDesign_nonull = data.frame(sample = as.factor(as.character(SAMPLE.D_nonull$Locality_my)))
studyDesign_nonull$group<-as.factor(as.character(SAMPLE.D_nonull$Locality_my))
studyDesign_nonull$individual<-as.factor(as.factor(1:dim(SAMPLE.D_nonull)[1]))
rownames(studyDesign_nonull)<-studyDesign_nonull$individual

#random effects
rL.group_nonull = HmscRandomLevel(units = levels(studyDesign_nonull$group))
rL.indiv_nonull = HmscRandomLevel(units = levels(studyDesign_nonull$individual))
rL.spatial_nonull = HmscRandomLevel(sData = xycoords_nonull)
rL.spatial_nonull = setPriors(rL.spatial_nonull,nfMin=1,nfMax=1)

#prejmenovat objekty
class(OTU_T.r)<-"matrix"

rownames(OTU_T.r)<-rownames(studyDesign)


####################################
#HURDLE MODEL#######################
####################################

OTU_T.r.prev<-OTU_T.r
OTU_T.r.abu<-OTU_T.r

OTU_T.r.prev[OTU_T.r.prev>0]<-1
OTU_T.r.abu[OTU_T.r.abu==0]<-NA

OTU_T.r.abu.f<-OTU_T.r.abu[FILTER.nonull,]

#A] counts

m = Hmsc(Y = OTU_T.r.abu.f, XData = SAMPLE.D_nonull,
         XFormula = ~Gravid_my+BW.s+Species+Admix.s+Transect+
           Species:Admix.s,
         studyDesign = studyDesign_nonull,
         ranLevels = list("sample" = rL.spatial_nonull,
                          "group"=rL.group_nonull,
                          "individual"=rL.indiv_nonull),
         distr="lognormal poisson")


BOTHTRANSECTS_ITS.hurdleAbu<-m


# Sys.time()
# m = sampleMcmc(BOTHTRANSECTS_ITS.hurdleAbu, thin = 1, samples = 1000, transient = 1,
#                nChains = 1, nParallel = 1, verbose =F,updater=list(GammaEta=FALSE))
# Sys.time()

HMSC_OBJ<-BOTHTRANSECTS_ITS.hurdleAbu
save(HMSC_OBJ,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/Hmsc_models/BOTHTRANSECTS_ITS.hurdleAbu.R")


#B] Prevalences

m = Hmsc(Y = OTU_T.r.prev, XData = SAMPLE.D, 
         XFormula = ~Gravid_my+BW.s+Species+Admix.s+Transect+
           Species:Admix.s,
         studyDesign = studyDesign, 
         ranLevels = list("sample" = rL.spatial,"group"=rL.group,"individual"=rL.indiv),
         distr="probit")

BOTHTRANSECTS_ITS.hurdlePrev<-m


Sys.time()
m = sampleMcmc(BOTHTRANSECTS_ITS.hurdlePrev, thin = 1, samples = 1000, transient = 1,
               nChains = 1, nParallel = 1, verbose =F,updater=list(GammaEta=FALSE))
Sys.time()

HMSC_OBJ<-BOTHTRANSECTS_ITS.hurdlePrev
save(HMSC_OBJ,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/Hmsc_models/BOTHTRANSECTS_ITS.hurdlePrev.R")

```

## Model without spatial autocorrelation 
```{r eval=FALSE, fig.width=15, include=FALSE}

####################################
#HURDLE MODEL#######################
####################################

OTU_T.r.prev<-OTU_T.r
OTU_T.r.abu<-OTU_T.r

OTU_T.r.prev[OTU_T.r.prev>0]<-1
OTU_T.r.abu[OTU_T.r.abu==0]<-NA

OTU_T.r.abu.f<-OTU_T.r.abu[FILTER.nonull,]

#A] counts
#filtrovani nulovych vzorku
m = Hmsc(Y = OTU_T.r.abu.f, XData = SAMPLE.D_nonull,
         XFormula = ~Gravid_my+BW.s+Species+Admix.s+Transect+
           Species:Admix.s,
         studyDesign = studyDesign_nonull,
         ranLevels = list("group"=rL.group_nonull,"individual"=rL.indiv_nonull),
         distr="lognormal poisson")

BOTHTRANSECTS_ITS.hurdleAbu<-m


# Sys.time()
# m = sampleMcmc(BOTHTRANSECTS_ITS.hurdleAbu, thin = 1, samples = 1000, transient = 1,
#                nChains = 1, nParallel = 1, verbose =F,updater=list(GammaEta=FALSE))
# Sys.time()

HMSC_OBJ<-BOTHTRANSECTS_ITS.hurdleAbu
save(HMSC_OBJ,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/Hmsc_models/BOTHTRANSECTS_ITSNOsp.hurdleAbu.R")


#B] Prevalences

m = Hmsc(Y = OTU_T.r.prev, XData = SAMPLE.D, 
         XFormula = ~Gravid_my+BW.s+Species+Admix.s+Transect+
           Species:Admix.s,
         studyDesign = studyDesign, 
         ranLevels = list("group"=rL.group,"individual"=rL.indiv),
         distr="probit")

BOTHTRANSECTS_ITS.hurdlePrev<-m


# Sys.time()
# m = sampleMcmc(BOTHTRANSECTS_ITS.hurdlePrev, thin = 1, samples = 1000, transient = 1,
#                nChains = 1, nParallel = 1, verbose =F,updater=list(GammaEta=FALSE))
# Sys.time()

HMSC_OBJ<-BOTHTRANSECTS_ITS.hurdlePrev
save(HMSC_OBJ,file = "/media/kreising/DATA/data/HM_hybrid_zone_all/Hmsc_models/BOTHTRANSECTS_ITSNOsp.hurdlePrev.R")

```
